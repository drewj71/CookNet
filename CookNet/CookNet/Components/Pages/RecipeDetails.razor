@page "/recipes/{RecipeId}"
@using CookNet.Data
@using Microsoft.AspNetCore.Identity
@inject RecipeService RecipeService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService
@rendermode InteractiveServer

@if (Recipe != null)
{
    <div>
        @if (IsUserAuthor)
        {
            <button class="btn btn-primary" @onclick="() => EditRecipe(Recipe.ID)">Edit</button>
        }

        <h4>@Recipe.Name</h4>
        <p>Author: <a class="text-decoration-none" href=@($"/users/{AuthorUserName}")>@("@")@AuthorUserName</a></p>
        <img src="@Recipe.ThumbnailImage" alt="RecipeThumbnail" class="img-fluid border rounded shadow m-2 p-2" style="width: 1920px; height: 1080px;">
        <p>@Recipe.Description</p>

        @if (Recipe.RecipeStories != null)
        {
            @foreach (var story in @Story)
            {
                <p>@($"{story.StoryText}")</p>
            }
        }
        <p>Prep Time: @Recipe.PrepTime mins</p>
        <p>Cook Time: @Recipe.CookTime mins</p>
        <p>Category: @Recipe.Category</p>

        @if (Recipe.Ethnicity != "NA")
        {
            <p>Ethnicity: @Recipe.Ethnicity</p>
        }

        <h5>Ingredients:</h5>
        <ul>
            @foreach (var ingredient in @RecipeIngredients)
            {
                <li>@($"{ingredient.Quantity} {ingredient.QuantityUnit} {ingredient.Name}")</li>
            }
        </ul>

        <h6>Instructions:</h6>
        <ul>
            @foreach (var instruction in @Instructions)
            {
                <li>@($"{instruction.StepNumber}. {instruction.InstructionText}")</li>
            }
        </ul>
    </div>
}
else
{
    <p>Loading...</p>
}

@code {
    [Inject]
    private UserManager<ApplicationUser> UserManager { get; set; }

    private Recipe Recipe;
    private List<Ingredient> RecipeIngredients = [];
    private List<RecipeStory> Story = [];
    private List<Instruction> Instructions = [];
    private string AuthorUserName;
    private bool IsUserAuthor = false;

    [Parameter]
    public string RecipeId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (int.TryParse(RecipeId, out int recipeId))
        {
            Recipe = await RecipeService.GetRecipeByIdAsync(recipeId);
            RecipeIngredients = await RecipeService.GetAllIngredientsAsync();
            Story = await RecipeService.GetRecipeStoryAsync();
            Instructions = await RecipeService.GetAllInstructionsAsync();

            if (Recipe != null)
            {
                // Fetch the author's username using the Recipe's AuthorID
                var author = await UserManager.FindByIdAsync(Recipe.AuthorID);
                AuthorUserName = author?.UserName ?? "Anonymous";

                // Check if the current user is the author
                var currentUser = await UserService.GetUserAsync();
                if (currentUser != null && currentUser.Id == Recipe.AuthorID)
                {
                    IsUserAuthor = true;
                }
            }
        }
    }


    private void EditRecipe(int recipeId)
    {
        NavigationManager.NavigateTo($"/edit-recipe/{recipeId}");
    }
}
